<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rishta Cotage</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="config.js"></script>

    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script async src="//www.instagram.com/embed.js"></script>
    
    <style>
        :root {
            --bg-dark: #121214;
            --bg-panel: #1b1b1f;
            --proton-purple: #6d4aff;
            --proton-accent: #c6bbf8;
            --text-main: #ffffff;
            --text-muted: #8b8b95;
            --font-main: 'Plus Jakarta Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .header-action {
            padding: 24px;
            display: none;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: safe-area-inset-top;
        }
        .action-label {
            font-weight: 600; font-size: 0.9rem; color: var(--proton-accent);
            opacity: 0; transform: translateX(10px); animation: slideIn 0.4s forwards;
        }
        .action-btn {
            background: var(--proton-purple); border: none; width: 48px; height: 48px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white;
            box-shadow: 0 4px 20px rgba(109, 74, 255, 0.4); cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .action-btn:active { transform: scale(0.9); }

        /* --- Main Content --- */
        main {
            flex: 1; overflow-y: auto; padding: 0 20px 140px 20px;
            scrollbar-width: none;
        }
        main::-webkit-scrollbar { display: none; }

        .page { display: none; animation: fadeUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .page.active { display: block; }
        
        h1 { font-size: 2.5rem; margin-bottom: 1rem; line-height: 1.1; letter-spacing: -0.03em; }
        .hero-title {
            text-transform: uppercase;
            text-align: center;
            margin-top: 30px;
            font-weight: 800;
            letter-spacing: -0.03em;
            line-height: 1;
        }
        p { color: var(--text-muted); line-height: 1.6; }

        /* --- Bubble Layout --- */
        .bubble-container {
            position: relative; height: 400px; width: 100%; max-width: 360px; margin: 30px auto 10px auto;
        }
        .bubble {
            object-fit: cover; position: absolute; transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: grayscale(0.2) contrast(1.1); box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        .bubble:hover { filter: grayscale(0); z-index: 20 !important; transform: scale(1.02); }

        .bubble-sm { width: 140px; height: 140px; top: 0; left: 0; border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; z-index: 2; }
        .bubble-lg { width: 220px; height: 220px; top: 60px; right: -10px; border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; z-index: 1; }
        .bubble-md { width: 170px; height: 170px; bottom: 10px; left: 10px; border-radius: 50% 50% 30% 70% / 50% 60% 40% 60%; z-index: 3; }

        /* --- Contact --- */
        .contact-section { text-align: center; margin-top: 20px; padding-bottom: 20px; }
        .contact-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); margin-bottom: 20px; font-weight: 800; opacity: 0.6; }
        .contact-icons { display: flex; justify-content: center; gap: 20px; }
        .c-icon {
            width: 50px; height: 50px; background: var(--bg-panel); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white;
            border: 1px solid rgba(255,255,255,0.08); transition: all 0.3s; cursor: pointer;
        }
        .c-icon:hover { background: var(--proton-purple); transform: translateY(-5px); border-color: var(--proton-purple); }

        /* --- Cards --- */
        .card-list { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        .card {
            background: var(--bg-panel); padding: 24px; border-radius: 28px;
            border: 1px solid rgba(255,255,255,0.05); overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .card h3 { margin-bottom: 12px; font-size: 1.2rem; font-weight: 700; }

        /* --- Embeds --- */
        .embed-container { margin-top: 16px; border-radius: 16px; overflow: hidden; min-height: 100px; position: relative; }
        .fallback-link {
            display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); padding: 18px; border-radius: 16px;
            text-decoration: none; color: var(--proton-accent); font-weight: 600; border: 1px solid rgba(255,255,255,0.05);
        }
        .link-preview { display: block; border-radius: 16px; overflow: hidden; background: #000; text-decoration: none; border: 1px solid rgba(255,255,255,0.1); }
        .lp-image { width: 100%; height: 180px; object-fit: cover; background: #222; }
        .lp-content { padding: 16px; background: #080808; }
        .lp-title { color: #fff; font-size: 1rem; font-weight: 700; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .lp-desc { color: #888; font-size: 0.85rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- Nav Dock --- */
        .nav-dock {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(27, 27, 31, 0.9); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 50px;
            padding: 8px 20px; display: flex; gap: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 100;
        }
        .nav-item {
            background: transparent; border: none; display: flex; flex-direction: column;
            align-items: center; justify-content: center; width: 60px; height: 60px;
            cursor: pointer; color: var(--text-muted); transition: all 0.3s ease;
        }
        .nav-item span { font-size: 0.75rem; margin-top: 5px; font-weight: 600; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active .icon-box { background: var(--proton-purple); color: white; transform: translateY(-3px) scale(1.05); }
        .icon-box { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 200;
            display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content {
            background: var(--bg-panel); width: 85%; max-width: 380px; padding: 32px;
            border-radius: 32px; border: 1px solid rgba(255,255,255,0.1); transform: scale(0.9); transition: transform 0.3s;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-input {
            width: 100%; background: var(--bg-dark); border: 1px solid #333; padding: 16px;
            border-radius: 16px; color: white; margin-bottom: 16px; font-family: inherit; font-size: 1rem;
        }
        .modal-file-label {
            display: block; width: 100%; padding: 16px; background: var(--bg-dark);
            border: 1px dashed #444; border-radius: 16px; text-align: center; color: var(--text-muted);
            margin-bottom: 16px; cursor: pointer; transition: 0.2s;
        }
        .modal-file-label:hover { border-color: var(--proton-purple); color: white; }
        .modal-btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; margin-top: 8px; font-size: 1rem; }
        .btn-post { background: var(--proton-purple); color: white; }
        .btn-cancel { background: transparent; color: #888; }
        
        /* Squad Item */
        .squad-item { display: flex; align-items: center; gap: 15px; }
        .squad-avatar { width: 50px; height: 50px; background: #333; border-radius: 50%; object-fit: cover; }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(15px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <header class="header-action" id="headerAction">
        <span class="action-label" id="actionLabel">Action</span>
        <button class="action-btn" onclick="handleHeaderClick()"><i data-lucide="plus"></i></button>
    </header>

    <main>
        <section id="about" class="page">
            <h1 class="hero-title">WELCOME TO<br><span style="color:var(--proton-purple)">RISHTA COTAGE</span></h1>
            <div class="bubble-container">
                <img src="https://picsum.photos/400/400?random=10" class="bubble bubble-sm">
                <img src="https://picsum.photos/400/400?random=11" class="bubble bubble-lg">
                <img src="https://picsum.photos/400/400?random=12" class="bubble bubble-md">
            </div>
            <div class="contact-section">
                <div class="contact-label">Contact Us</div>
                <div class="contact-icons">
                    <div class="c-icon"><i data-lucide="facebook"></i></div>
                    <div class="c-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    </div>
                    <div class="c-icon"><i data-lucide="mail"></i></div>
                </div>
            </div>
        </section>

        <section id="posts" class="page">
            <h1>Feed</h1>
            <div class="card-list" id="feedContainer"></div>
        </section>

        <section id="members" class="page">
            <h1>Squad</h1>
            <div class="card-list" id="squadContainer">
                <p style="text-align:center; color:#444;">Loading squad...</p>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="postModal">
        <div class="modal-content">
            <h2 style="margin-bottom:24px;">New Post</h2>
            <input type="text" id="inputTitle" class="modal-input" placeholder="Give it a title...">
            <input type="text" id="inputLink" class="modal-input" placeholder="Paste link...">
            <button class="modal-btn btn-post" onclick="createPost()">Post</button>
            <button class="modal-btn btn-cancel" onclick="closeModal('postModal')">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="memberModal">
        <div class="modal-content">
            <h2 style="margin-bottom:24px;">Add Squad Member</h2>
            <input type="text" id="memName" class="modal-input" placeholder="Member Name">
            
            <label class="modal-file-label" for="memFile">
                <span id="fileNameLabel">Tap to select photo...</span>
                <input type="file" id="memFile" accept="image/*" style="display:none" onchange="updateFileLabel(this)">
            </label>
            
            <input type="password" id="memPass" class="modal-input" placeholder="Enter Password">
            
            <button class="modal-btn btn-post" onclick="createMember()">Add Member</button>
            <button class="modal-btn btn-cancel" onclick="closeModal('memberModal')">Cancel</button>
        </div>
    </div>

    <nav class="nav-dock">
        <button class="nav-item" id="nav-about" onclick="switchTab('about')"><div class="icon-box"><i data-lucide="sparkles"></i></div><span>About</span></button>
        <button class="nav-item" id="nav-posts" onclick="switchTab('posts')"><div class="icon-box"><i data-lucide="layers"></i></div><span>Feed</span></button>
        <button class="nav-item" id="nav-members" onclick="switchTab('members')"><div class="icon-box"><i data-lucide="users"></i></div><span>Squad</span></button>
    </nav>

    <script>
        lucide.createIcons();
        if (typeof CONFIG === 'undefined') throw new Error("Config missing");
        const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            let lastTab = localStorage.getItem('lastViewedTab') || 'about';
            if(lastTab === 'topics') lastTab = 'about';
            switchTab(lastTab, false);
            loadPosts();
            loadSquad();
        });

        let currentTab = 'about';

        function switchTab(tabId, animate = true) {
            currentTab = tabId;
            localStorage.setItem('lastViewedTab', tabId);
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${tabId}`).classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const header = document.getElementById('headerAction');
            const label = document.getElementById('actionLabel');
            if (animate) { label.style.animation = 'none'; label.offsetHeight; label.style.animation = null; }

            if (tabId === 'posts') { header.style.display = 'flex'; label.innerText = 'link new post'; }
            else if (tabId === 'members') { header.style.display = 'flex'; label.innerText = 'add member'; }
            else { header.style.display = 'none'; }
            setTimeout(() => lucide.createIcons(), 50);
        }

        function handleHeaderClick() {
            if(currentTab === 'posts') document.getElementById('postModal').classList.add('open');
            if(currentTab === 'members') document.getElementById('memberModal').classList.add('open');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
            // Clear inputs
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('fileNameLabel').innerText = 'Tap to select photo...';
        }

        function updateFileLabel(input) {
            if (input.files.length > 0) {
                document.getElementById('fileNameLabel').innerText = input.files[0].name;
            }
        }

        // --- SQUAD LOGIC ---
        async function loadSquad() {
            const container = document.getElementById('squadContainer');
            const { data, error } = await supabase.from('squad').select('*').order('created_at', { ascending: false });

            if (error) return;
            container.innerHTML = '';
            if(!data || data.length === 0) {
                container.innerHTML = `<p style="text-align:center;">No members yet.</p>`;
                return;
            }

            data.forEach(mem => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="squad-item">
                        <img src="${mem.image_url}" class="squad-avatar">
                        <h3>${mem.name}</h3>
                    </div>`;
                container.appendChild(div);
            });
        }

        async function createMember() {
            const name = document.getElementById('memName').value;
            const pass = document.getElementById('memPass').value;
            const fileInput = document.getElementById('memFile');
            const btn = document.querySelector('#memberModal .btn-post');

            // 1. Check Password
            if (pass !== 'risht33') {
                alert("Wrong password!");
                return;
            }
            if (!name || fileInput.files.length === 0) {
                alert("Please enter name and select image");
                return;
            }

            btn.innerText = "Uploading...";
            btn.disabled = true;

            // 2. Rename File
            const file = fileInput.files[0];
            const randomNum = Math.floor(Math.random() * 900) + 100; // 3 digit
            const fileExt = file.name.split('.').pop();
            const newFileName = `${name.replace(/\s+/g, '')}_${randomNum}.${fileExt}`;

            // 3. Upload to Supabase Storage
            const { data: uploadData, error: uploadError } = await supabase
                .storage
                .from('squad-avatars')
                .upload(newFileName, file);

            if (uploadError) {
                alert("Upload failed: " + uploadError.message);
                btn.innerText = "Add Member";
                btn.disabled = false;
                return;
            }

            // 4. Get Public URL
            const { data: urlData } = supabase.storage.from('squad-avatars').getPublicUrl(newFileName);
            const publicUrl = urlData.publicUrl;

            // 5. Save to Database
            const { error: dbError } = await supabase.from('squad').insert([{ name: name, image_url: publicUrl }]);

            if (dbError) {
                alert("DB Error: " + dbError.message);
            } else {
                closeModal('memberModal');
                loadSquad();
            }
            btn.innerText = "Add Member";
            btn.disabled = false;
        }

        // --- POSTS LOGIC (Same as before) ---
        async function loadPosts() {
            const feed = document.getElementById('feedContainer');
            const { data, error } = await supabase.from('posts').select('*').order('created_at', { ascending: false });
            if (error) return;
            feed.innerHTML = '';
            if(!data || data.length === 0) { feed.innerHTML = `<p style="text-align:center;">No posts yet.</p>`; return; }
            data.forEach(post => renderPostHTML(post));
            if (window.instgrm) setTimeout(() => window.instgrm.Embeds.process(), 1000);
        }

        async function createPost() {
            const title = document.getElementById('inputTitle').value;
            const link = document.getElementById('inputLink').value;
            const btn = document.querySelector('#postModal .btn-post');
            if(!title || !link) return;
            btn.innerText = "Posting..."; btn.disabled = true;
            const { error } = await supabase.from('posts').insert([{ title: title, link: link }]);
            if (error) alert(error.message);
            else { closeModal('postModal'); loadPosts(); }
            btn.innerText = "Post"; btn.disabled = false;
        }

        function renderPostHTML(post) {
            const feed = document.getElementById('feedContainer');
            const div = document.createElement('div');
            div.className = 'card';
            const date = new Date(post.created_at).toLocaleDateString();
            const uniqueId = `embed-${post.id}`;
            div.innerHTML = `<h3>${post.title}</h3><p style="font-size:0.85rem;margin-bottom:12px;color:var(--text-muted)">Posted: ${date}</p><div class="embed-container" id="${uniqueId}"></div>`;
            feed.appendChild(div);
            const container = document.getElementById(uniqueId);
            const url = post.link;

            if (url.match(/(twitter\.com|x\.com)/)) {
                const match = url.match(/\/status\/(\d+)/);
                if (match && match[1] && window.twttr) {
                    window.twttr.widgets.createTweet(match[1], container, { theme: 'dark', align: 'center', conversation: 'none' });
                } else container.innerHTML = `<a href="${url}" target="_blank" class="fallback-link"><i data-lucide="external-link"></i><span>View on X</span></a>`;
            } 
            else if (url.match(/(instagram\.com)/)) {
                container.innerHTML = `<blockquote class="instagram-media" data-instgrm-permalink="${url.split('?')[0]}" data-instgrm-version="14" style="background:#FFF;border:0;border-radius:3px;margin:1px;min-width:326px;width:calc(100% - 2px);"><div style="padding:16px;"><a href="${url.split('?')[0]}" target="_blank">View on Instagram</a></div></blockquote>`;
            }
            else {
                const apiUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
                container.innerHTML = `<div class="lp-image" style="background:#222;display:flex;align-items:center;justify-content:center;color:#555">Loading...</div>`;
                fetch(apiUrl).then(res=>res.json()).then(data=>{
                    if(data.status==='success') container.innerHTML = `<a href="${url}" target="_blank" class="link-preview"><img src="${data.data.image?.url||''}" class="lp-image"><div class="lp-content"><div class="lp-title">${data.data.title||url}</div><div class="lp-desc">${data.data.description||'Open link'}</div></div></a>`;
                    else container.innerHTML = `<a href="${url}" target="_blank" class="fallback-link"><i data-lucide="external-link"></i><span>Open Link</span></a>`;
                });
            }
        }
    </script>
</body>
</html>